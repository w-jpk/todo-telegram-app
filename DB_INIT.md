# Инициализация базы данных

## Обзор

Проект автоматически инициализирует схему БД при первом подключении. Также доступны способы явной инициализации.

## Автоматическая инициализация

При первом подключении к БД (при первом запросе к API) автоматически выполняется инициализация схемы:
- Создаются все необходимые таблицы
- Создаются индексы для оптимизации
- Создаются дефолтные данные (проект "Inbox", настройки)
- В dev режиме автоматически создается тестовый пользователь (ID: 123456789)

## Ручная инициализация

### Вариант 1: Node.js скрипт (рекомендуется)

```bash
npm run db:init
```

Этот скрипт:
- Создает все таблицы
- Добавляет недостающие колонки к существующим таблицам
- Создает все индексы
- Создает дефолтные данные
- В dev режиме создает тестового пользователя (ID: 123456789)

### Вариант 2: SQL скрипт

```bash
npm run db:init:sql
```

Или напрямую:

```bash
psql $DATABASE_URL -f scripts/init-db.sql
```

### Вариант 3: API endpoint (только в dev режиме)

1. Запустите dev сервер: `npm run dev`
2. Вызовите API endpoint:

```bash
npm run db:init:api
```

Или напрямую:

```bash
curl -X POST http://localhost:3002/api/db/init
```

**Важно:** API endpoint доступен только в dev режиме для безопасности.

## Структура базы данных

### Таблицы

1. **users** - Пользователи Telegram
   - `id` (BIGINT) - ID пользователя Telegram (Primary Key)
   - `first_name`, `last_name`, `username` - Данные пользователя
   - `language_code`, `is_premium` - Дополнительная информация

2. **projects** - Проекты пользователей
   - `id` (UUID) - ID проекта
   - `user_id` (BIGINT) - ID пользователя (Foreign Key)
   - `name`, `color` - Название и цвет проекта

3. **todos** - Задачи
   - `id` (UUID) - ID задачи
   - `user_id` (BIGINT) - ID пользователя
   - `project_id` (UUID) - ID проекта (опционально)
   - `parent_id` (UUID) - ID родительской задачи (для подзадач)
   - `text`, `description` - Текст задачи
   - `completed`, `priority` - Статус и приоритет
   - `due_date` - Срок выполнения
   - `recurrence_*` - Поля для повторяющихся задач
   - `is_recurring` - Флаг повторяющейся задачи

4. **tags** - Теги
   - `id` (UUID) - ID тега
   - `user_id` (BIGINT) - ID пользователя
   - `name`, `color` - Название и цвет тега

5. **todo_tags** - Связь задач и тегов (many-to-many)
   - `todo_id` (UUID) - ID задачи
   - `tag_id` (UUID) - ID тега

6. **user_settings** - Настройки пользователя
   - `user_id` (BIGINT) - ID пользователя (Primary Key)
   - Различные настройки уведомлений, темы, языка и т.д.

### Индексы

Созданы индексы для оптимизации запросов:
- `idx_todos_user_id` - Поиск задач пользователя
- `idx_todos_completed` - Фильтрация по статусу
- `idx_todos_due_date` - Фильтрация по сроку
- `idx_todos_priority` - Сортировка по приоритету
- `idx_todos_project_id` - Фильтрация по проекту
- `idx_todos_parent_id` - Поиск подзадач
- `idx_todos_is_recurring` - Фильтрация повторяющихся задач
- `idx_todos_recurrence_parent_id` - Поиск экземпляров повторяющейся задачи
- `idx_projects_user_id` - Поиск проектов пользователя
- `idx_tags_user_id` - Поиск тегов пользователя
- `idx_todo_tags_todo_id` - Поиск тегов задачи
- `idx_todo_tags_tag_id` - Поиск задач по тегу
- `idx_user_settings_notifications` - Фильтрация по настройкам уведомлений

## Тестовый пользователь в dev режиме

В dev режиме автоматически создается тестовый пользователь:
- **ID:** 123456789
- **Имя:** Test User
- **Username:** testuser
- **Язык:** ru

Также создаются:
- Дефолтный проект "Inbox"
- Дефолтные настройки

## Обновление существующей схемы

Скрипт `init-db.js` автоматически добавляет недостающие колонки к существующим таблицам:
- Колонки для повторяющихся задач в `todos`
- Колонки `theme` и `language` в `user_settings`

Это позволяет безопасно обновлять существующую БД без потери данных.

## Миграции

**Рекомендация:** В будущем использовать систему миграций (например, Knex.js или аналоги) для управления изменениями схемы БД в продакшене.

## Troubleshooting

### Ошибка подключения к БД
- Проверьте, что `DATABASE_URL` установлен в `.env` файле
- Проверьте, что PostgreSQL запущен
- Проверьте права доступа к БД

### Ошибки при создании таблиц
- Убедитесь, что у пользователя БД есть права на создание таблиц
- Проверьте, что БД существует

### Ошибки с индексами
- Индексы создаются с `IF NOT EXISTS`, ошибки обычно игнорируются
- Если индекс не создается, проверьте логи

## Команды

| Команда | Описание |
|---------|----------|
| `npm run db:init` | Инициализация БД через Node.js скрипт |
| `npm run db:init:sql` | Инициализация БД через SQL скрипт |
| `npm run db:init:api` | Инициализация БД через API endpoint (dev режим) |

## Примечания

- Все операции идемпотентны - можно безопасно запускать несколько раз
- Скрипты используют `IF NOT EXISTS` и `ON CONFLICT DO NOTHING` для избежания ошибок
- Автоматическая инициализация происходит асинхронно и не блокирует приложение

